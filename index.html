<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>GestiÃ³n Taller</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  input, select { margin: 2px; }
  button { margin: 5px; }
  .ot { padding: 2px 0; }
  .ot button { margin-left: 10px; }
</style>
</head>
<body>

<h2>GestiÃ³n Taller â€” OTs y Prima</h2>

<!-- Selector de mes -->
Mes: 
<select id="mes" onchange="cambiarMes()">
</select>
<button onclick="nuevoMes()">Nuevo Mes</button>
Horas potenciales: <input type="number" id="potenciales" placeholder="160">
<button onclick="guardarMes()">Guardar / Cargar mes</button>

<hr>

<!-- AÃ±adir OT -->
OT nÃºmero: <input type="text" id="otNumero" placeholder="61450">
Horas: <input type="number" id="horas" placeholder="1">
Minutos: <input type="number" id="minutos" placeholder="30">
<button onclick="addOT()">AÃ±adir OT</button>

<hr>

<!-- Resumen mensual -->
<div id="resumen"></div>

<!-- Lista de OTs -->
<div id="listaOT"></div>

<script>
let datos = JSON.parse(localStorage.getItem("produccion")) || {};
let mesActual = localStorage.getItem("mesActivo") || "";

// Inicializar selector de meses
function actualizarSelector() {
  const select = document.getElementById("mes");
  select.innerHTML = "";
  for (let mes in datos) {
    const option = document.createElement("option");
    option.value = mes;
    option.textContent = mes;
    if(mes === mesActual) option.selected = true;
    select.appendChild(option);
  }
}

// Nuevo mes
function nuevoMes() {
  const nuevo = prompt("Nombre del nuevo mes (Ej: Febrero 2026)");
  if (!nuevo) return;
  if (!datos[nuevo]) {
    datos[nuevo] = { potenciales: 160, ots: [] };
    mesActual = nuevo;
    localStorage.setItem("mesActivo", mesActual);
    guardar();
    actualizarSelector();
    document.getElementById("mes").value = mesActual;
    document.getElementById("potenciales").value = 160;
    actualizar();
  } else {
    alert("Ese mes ya existe");
  }
}

// Cambiar mes desde selector
function cambiarMes() {
  mesActual = document.getElementById("mes").value;
  localStorage.setItem("mesActivo", mesActual);
  document.getElementById("potenciales").value = datos[mesActual].potenciales;
  actualizar();
}

// Guardar mes (horas potenciales)
function guardarMes() {
  if (!mesActual) return alert("Selecciona o crea un mes primero");
  const potenciales = Number(document.getElementById("potenciales").value);
  datos[mesActual].potenciales = potenciales;
  guardar();
  actualizar();
}

// AÃ±adir OT
function addOT() {
  if (!mesActual) return alert("Selecciona o crea un mes primero");
  const ot = document.getElementById("otNumero").value;
  const h = Number(document.getElementById("horas").value);
  const m = Number(document.getElementById("minutos").value);
  if(!ot) return alert("Pon nÃºmero de OT");
  const totalHoras = h + (m/60);
  datos[mesActual].ots.push({ ot, horas: totalHoras });
  guardar();
  actualizar();
  document.getElementById("otNumero").value = "";
  document.getElementById("horas").value = "";
  document.getElementById("minutos").value = "";
}

// Borrar OT
function borrarOT(index) {
  if (!mesActual) return;
  datos[mesActual].ots.splice(index,1);
  guardar();
  actualizar();
}

// Actualizar pantalla
function actualizar() {
  if (!mesActual) return;
  const mes = datos[mesActual];
  if(!mes) return;
  
  let vendidas = mes.ots.reduce((s,o)=>s+o.horas,0);
  let potencialesAjustadas = mes.potenciales * 0.95;
  let primaHoras = Math.max(0, vendidas - potencialesAjustadas);
  let primaEuros = primaHoras * 14;
  let produccion = (vendidas / potencialesAjustadas) * 100;

  document.getElementById("resumen").innerHTML = `
    <b>${mesActual}</b><br>
    Horas vendidas: <b>${vendidas.toFixed(2)}</b><br>
    Potenciales (âˆ’5%): <b>${potencialesAjustadas.toFixed(2)}</b><br>
    Prima: <b>${primaHoras.toFixed(2)} h</b> ðŸ’° ${primaEuros.toFixed(2)} â‚¬<br>
    ProducciÃ³n: <b>${produccion.toFixed(1)}%</b>
  `;

  const lista = document.getElementById("listaOT");
  lista.innerHTML = "";
  mes.ots.forEach((o,i)=>{
    lista.innerHTML += `<div class="ot">OT ${o.ot} â†’ ${o.horas.toFixed(2)} h
      <button onclick="borrarOT(${i})">Borrar</button></div>`;
  });

  actualizarSelector();
}

// Guardar en localStorage
function guardar() {
  localStorage.setItem("produccion", JSON.stringify(datos));
}

// InicializaciÃ³n al abrir
actualizarSelector();
if(mesActual) {
  document.getElementById("mes").value = mesActual;
  document.getElementById("potenciales").value = datos[mesActual].potenciales;
  actualizar();
}
</script>

</body>
</html>

