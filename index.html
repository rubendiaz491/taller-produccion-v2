<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gesti√≥n Taller Visual Estable</title>
<style>
  body { font-family: sans-serif; margin: 10px; max-width: 480px; }
  input, select, button { margin: 5px 0; width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box; }
  button { cursor: pointer; }
  .ot { 
    padding: 10px; margin: 5px 0; border-radius: 8px; 
    background-color: #f0f0f0; display: flex; justify-content: space-between; 
    align-items: center; 
  }
  .ot:nth-child(even){ background-color:#e0e0e0; }
  #resumen {
    padding: 15px; margin: 10px 0; border-radius: 10px; background: #fafafa; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    font-size: 16px;
  }
  .produccion { font-weight: bold; }
  .prima { font-weight: bold; }
  .barra-produccion {
    height: 20px; border-radius: 10px; background: #ddd; margin-top: 5px; overflow: hidden;
  }
  .barra-produccion-inner {
    height: 100%; width: 0%; background: green; text-align: right; padding-right: 5px;
    color: white; font-weight: bold; border-radius: 10px;
    box-sizing: border-box;
  }
</style>
</head>
<body>

<h2>Gesti√≥n Taller ‚Äî OTs y Prima</h2>

<!-- Selector de mes -->
<select id="mes" onchange="cambiarMes()"></select>
<button onclick="nuevoMes()">+ Nuevo Mes</button>
Horas potenciales: <input type="number" id="potenciales" placeholder="160">
<button onclick="guardarMes()">Guardar / Cargar mes</button>
<button onclick="borrarMes()" style="background-color:red;color:white;">Borrar mes</button>

<hr>

<!-- A√±adir OT -->
OT n√∫mero: <input type="text" id="otNumero" placeholder="61450">
Horas: <input type="number" id="horas" placeholder="1">
Minutos: <input type="number" id="minutos" placeholder="30">
<button onclick="addOT()">A√±adir OT</button>

<hr>

<!-- Resumen mensual -->
<div id="resumen"></div>

<!-- Barra de progreso de producci√≥n -->
<div class="barra-produccion"><div class="barra-produccion-inner" id="barraProd">0%</div></div>

<!-- Lista de OTs -->
<div id="listaOT"></div>

<script>
let datos = JSON.parse(localStorage.getItem("produccion")) || {};
let mesActual = localStorage.getItem("mesActivo") || "";

// Actualizar selector de meses
function actualizarSelector(){
  const select = document.getElementById("mes");
  select.innerHTML = "";
  for(let mes in datos){
    const opt = document.createElement("option");
    opt.value = mes;
    opt.textContent = mes;
    if(mes===mesActual) opt.selected = true;
    select.appendChild(opt);
  }
}

// Crear nuevo mes
function nuevoMes(){
  const nuevo = prompt("Nombre del nuevo mes (Ej: Febrero 2026)");
  if(!nuevo) return;
  if(!datos[nuevo]){
    datos[nuevo] = { potenciales:160, ots:[] };
    mesActual = nuevo;
    localStorage.setItem("mesActivo", mesActual);
    guardar();
    actualizarSelector();
    document.getElementById("mes").value = mesActual;
    document.getElementById("potenciales").value = 160;
    actualizar();
  } else alert("Ese mes ya existe");
}

// Cambiar mes desde selector
function cambiarMes(){
  mesActual = document.getElementById("mes").value;
  localStorage.setItem("mesActivo", mesActual);
  document.getElementById("potenciales").value = datos[mesActual].potenciales;
  actualizar();
}

// Guardar mes
function guardarMes(){
  if(!mesActual) return alert("Selecciona o crea un mes primero");
  datos[mesActual].potenciales = Number(document.getElementById("potenciales").value);
  guardar();
  actualizar();
}

// A√±adir OT
function addOT(){
  if(!mesActual) return alert("Selecciona o crea un mes primero");
  const ot = document.getElementById("otNumero").value.trim();
  const h = Number(document.getElementById("horas").value);
  const m = Number(document.getElementById("minutos").value);
  if(!ot) return alert("Pon n√∫mero de OT");
  const totalHoras = h + (m/60);
  datos[mesActual].ots.push({ ot, horas: totalHoras });
  guardar();
  actualizar();
  document.getElementById("otNumero").value="";
  document.getElementById("horas").value="";
  document.getElementById("minutos").value="";
}

// Borrar OT
function borrarOT(index){
  if(!mesActual) return;
  datos[mesActual].ots.splice(index,1);
  guardar();
  actualizar();
}

// Borrar mes completo
function borrarMes(){
  if(!mesActual) return;
  if(!confirm(`¬øSeguro que quieres borrar el mes ${mesActual}? Se perder√°n todas las OTs y datos.`)) return;
  delete datos[mesActual];
  guardar();

  const meses = Object.keys(datos);
  mesActual = meses.length > 0 ? meses[0] : "";
  localStorage.setItem("mesActivo", mesActual);
  document.getElementById("mes").value = mesActual;
  if(mesActual) document.getElementById("potenciales").value = datos[mesActual].potenciales;
  actualizar();
}

// Actualizar pantalla
function actualizar(){
  if(!mesActual) return;
  const mes = datos[mesActual];
  if(!mes) return;

  let vendidas = mes.ots.reduce((s,o)=>s+o.horas,0);
  let potencialesAjustadas = mes.potenciales*0.95;
  let primaHoras = Math.max(0,vendidas-potencialesAjustadas);
  let primaEuros = primaHoras*14;
  let produccion = (vendidas/potencialesAjustadas)*100;

  // Colores din√°micos
  let colorProd = produccion<100?"red":(produccion===100?"orange":"green");
  let colorPrima = primaHoras>0?"green":"gray";

  // Mostrar resumen
  document.getElementById("resumen").innerHTML=`
    <b>${mesActual}</b><br>
    Horas vendidas: <b>${vendidas.toFixed(2)}</b><br>
    Potenciales (‚àí5%): <b>${potencialesAjustadas.toFixed(2)}</b><br>
    Prima: <span class="prima" style="color:${colorPrima}">${primaHoras.toFixed(2)} h</span> üí∞ ${primaEuros.toFixed(2)} ‚Ç¨<br>
    Producci√≥n: <span class="produccion" style="color:${colorProd}">${produccion.toFixed(1)}%</span>
  `;

  // Barra de progreso
  const barra = document.getElementById("barraProd");
  barra.style.width = Math.min(produccion,150) + "%";
  barra.style.background = colorProd;
  barra.textContent = produccion.toFixed(1) + "%";

  // Lista de OTs
  const lista = document.getElementById("listaOT");
  lista.innerHTML="";
  mes.ots.forEach((o,i)=>{
    lista.innerHTML += `<div class="ot">OT ${o.ot} ‚Üí ${o.horas.toFixed(2)} h
      <button onclick="borrarOT(${i})">Borrar</button></div>`;
  });

  actualizarSelector();
}

// Guardar en localStorage
function guardar(){ localStorage.setItem("produccion",JSON.stringify(datos)); }

// Inicializaci√≥n
actualizarSelector();
if(mesActual){
  document.getElementById("mes").value = mesActual;
  document.getElementById("potenciales").value = datos[mesActual].potenciales;
  actualizar();
}
</script>

</body>
</html>
